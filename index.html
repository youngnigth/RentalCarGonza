<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrailTrack Rentals — SUV Only</title>
  <meta name="description" content="SUV-only car rentals with live GPS pick-up and return map." />
  <link rel="preconnect" href="https://unpkg.com"/>
  <link rel="preconnect" href="https://tile.openstreetmap.org"/>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      /* === Brand config: update these to match your brand === */
      --brand:#0f172a; /* deep slate */
      --brand-2:#1e293b;
      --accent:#06b6d4; /* cyan accent */
      --muted:#64748b;
      --bg:#f8fafc;
      --radius:16px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:linear-gradient(180deg,#fff, var(--bg)); color:#0f172a }
    a{ color:var(--accent); text-decoration:none }
    header{ position:sticky; top:0; backdrop-filter: blur(6px); background:rgba(255,255,255,.8); border-bottom:1px solid #e5e7eb; z-index:10 }
    .container{ max-width:1200px; margin:0 auto; padding:16px }
    .brand{ display:flex; align-items:center; gap:12px }
    .logo{ height:40px; width:40px; border-radius:12px; background:var(--brand); color:#fff; display:grid; place-items:center; font-weight:700 }
    .grid{ display:grid; grid-template-columns:1fr; gap:20px; margin-top:20px }
    @media (min-width: 980px){ .grid{ grid-template-columns: 2fr 1fr } }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:var(--radius); overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .card .pad{ padding:16px }
    .fleet{ display:grid; grid-template-columns: 1fr; gap:16px }
    @media (min-width: 640px){ .fleet{ grid-template-columns: 1fr 1fr } }
    .vehicle{ cursor:pointer; transition: box-shadow .2s, transform .02s; border-radius:var(--radius); overflow:hidden; border:1px solid #e5e7eb; }
    .vehicle:hover{ box-shadow: 0 8px 28px rgba(2,6,23,.08) }
    .vehicle.active{ outline: 2px solid var(--brand); }
    .vehicle img{ width:100%; height:200px; object-fit:cover; display:block }
    .row{ display:flex; justify-content:space-between; align-items:center }
    .muted{ color: var(--muted); font-size:12px }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px }
    .chip{ font-size:11px; background:#f1f5f9; padding:4px 8px; border-radius:999px }
    label{ font-size:13px; color:#0f172a; display:block; margin-bottom:6px }
    input[type="date"], input[readonly], select, button, input[type="text"], input[type="email"], textarea{ width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font:inherit }
    input[readonly]{ background:#f8fafc; color:#334155 }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .range-wrap{ padding-top:8px }
    .btn{ appearance:none; border:1px solid var(--brand); background:var(--brand); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600 }
    .btn.secondary{ background:#fff; color:var(--brand) }
    .btn.small{ padding:6px 10px; font-size:12px }
    .btn.accent{ background:var(--accent); border-color:var(--accent); color:#003 }
    .map-wrap{ position:relative; height:340px; border-radius:var(--radius); overflow:hidden; border:1px solid #e5e7eb }
    #map{ height:100%; width:100% }
    .map-ctrl{ position:absolute; top:10px; left:10px; display:flex; gap:8px; z-index: 500 }
    .totals{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:flex-end }
    .totals .kv{ font-size:14px; display:flex; justify-content:space-between; }
    .est{ text-align:right }
    .est .label{ color: var(--muted); font-size:12px }
    .est .value{ font-size:28px; font-weight:700 }
    footer{ margin:40px 0 60px }
    .notice{ font-size:11px; color:#64748b }
    .contact-grid{ display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width: 640px){ .contact-grid{ grid-template-columns:1fr 1fr } }
    .success{ background:#ecfeff; border:1px solid #a5f3fc; padding:10px; border-radius:10px; color:#0c4a6e; display:none }
    .error{ background:#fff1f2; border:1px solid #fecdd3; padding:10px; border-radius:10px; color:#9f1239; display:none }
  </style>
</head>
<body>
  <header>
    <div class="container row" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div class="brand">
        <!-- Replace with your own logo image if desired -->
        <img src="assets/logo.svg" alt="TrailTrack" class="logo" style="background:none"/>
        <div>
          <div style="font-weight:800">TrailTrack Rentals</div>
          <div class="muted">SUV-only fleet • GPS pick-up & return</div>
        </div>
      </div>
      <div style="display:flex; gap:10px">
        <button class="btn secondary" onclick="document.querySelector('#contact').scrollIntoView({behavior:'smooth'})">Contact</button>
        <button class="btn" onclick="document.querySelector('#book').scrollIntoView({behavior:'smooth'})">Book now</button>
      </div>
    </div>
  </header>

  <main class="container grid">
    <!-- Fleet Gallery -->
    <section class="card">
      <div class="pad">
        <h2 style="margin:0 0 10px; font-size:18px">Choose your SUV</h2>
        <div class="fleet" id="fleet"></div>
      </div>
    </section>

    <!-- Booking Panel -->
    <aside id="book" class="card">
      <div class="pad">
        <h2 style="margin:0 0 10px; font-size:18px">Your trip</h2>

        <div class="grid2">
          <div>
            <label for="start">Pick-up date</label>
            <input id="start" type="date" />
          </div>
          <div>
            <label for="end">Return date</label>
            <input id="end" type="date" />
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Driver age</label>
            <div class="range-wrap">
              <input id="age" type="range" min="21" max="75" step="1" value="30"/>
              <div class="muted" id="ageLabel">30 years</div>
            </div>
          </div>
          <div>
            <label for="vehicle">Vehicle</label>
            <select id="vehicle"></select>
          </div>
        </div>

        <!-- Customer email for reservation -->
        <div style="margin-top:12px">
          <label for="email">Your email (for confirmation)</label>
          <input id="email" type="email" placeholder="you@example.com" required />
          <div class="muted" style="margin-top:4px">We’ll email your reservation details here.</div>
        </div>

        <!-- STATIC PICKUP UI (no user controls) -->
        <div style="margin-top:12px">
          <label>Pick-up location</label>
          <input id="pickupField" type="text" readonly />
          <div class="muted" style="margin-top:4px">Pick-up is fixed at our office.</div>
        </div>

        <div style="margin-top:12px">
          <label>Return location</label>
          <div class="grid2">
            <button class="btn secondary small" onclick="geo('dropoff')">Use my location</button>
            <input id="dropoffField" type="text" readonly />
          </div>
          <div class="muted" style="margin-top:6px">Click on the map to set the return location.</div>
        </div>

        <div class="map-wrap" style="margin-top:12px">
          <div class="map-ctrl">
            <!-- Only one control now: Set Return -->
            <button id="modeDropoff" class="btn secondary small" disabled>Return mode</button>
          </div>
          <div id="map"></div>
        </div>

        <div class="totals" style="margin-top:12px">
          <div>
            <div class="kv"><span>Days</span><strong id="days">1</strong></div>
            <div class="kv"><span id="baseLabel">Base</span><strong id="base">$0.00</strong></div>
            <div class="kv"><span>One-time fees</span><strong id="oneTime">$4.99</strong></div>
            <div class="kv" id="under25Row" style="display:none"><span>Young driver</span><strong id="under25">$0.00</strong></div>
            <div class="kv" id="deliveryRow" style="display:none"><span id="deliveryLabel">Different return</span><strong id="delivery">$0.00</strong></div>
            <div class="kv"><span>Tax (4%)</span><strong id="tax">$0.00</strong></div>
          </div>
          <div class="est">
            <div class="label">Estimated total</div>
            <div class="value" id="total">$0.00</div>

            <div id="availMsg" class="muted" style="margin-top:6px"></div>

            <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
              <button class="btn" onclick="reserve()">Request reservation</button>
              <button class="btn accent" onclick="payNow()">Book & Pay</button>
            </div>
            <div class="muted" style="margin-top:6px">* Demo only. Replace STRIPE_PAYMENT_LINK in config to enable real checkout.</div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Contact section -->
  <section id="contact" class="container" style="margin-top:20px">
    <div class="card">
      <div class="pad">
        <h2>Contact us</h2>
        <p class="muted">Questions? Send us a message and we’ll reply shortly.</p>
        <div class="success" id="contactSuccess">Thanks! Your message was sent.</div>
        <div class="error" id="contactError">Sorry, something went wrong sending your message.</div>
        <form id="contactForm" onsubmit="sendContact(event)">
          <div class="contact-grid">
            <div>
              <label for="cname">Name</label>
              <input id="cname" type="text" required />
            </div>
            <div>
              <label for="cemail">Email</label>
              <input id="cemail" type="email" required />
            </div>
          </div>
          <label for="cmsg" style="margin-top:6px">Message</label>
          <textarea id="cmsg" rows="5" required></textarea>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center">
            <button class="btn" type="submit">Send</button>
            <span class="muted">Powered by EmailJS — set your keys in the config.</span>
          </div>
        </form>
      </div>
    </div>
  </section>

  <footer class="container">
    <div class="grid">
      <section>
        <h3>Why TrailTrack?</h3>
        <p>Only SUVs. Flexible pick-up & return with live GPS. Clean vehicles, transparent pricing, and friendly support.</p>
      </section>
      <section>
        <h3>Policy highlights</h3>
        <ul>
          <li>21+ to rent (under-25 fee may apply)</li>
          <li>Unlimited drivers from same household</li>
          <li>No smoking • No pets (service animals OK)</li>
        </ul>
      </section>
    </div>
    <p style="margin-top:14px" class="muted">© 2025 TrailTrack Rentals — support@trailtrack.example</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- EmailJS SDK (loaded only if you set keys) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    /* =========================
       CONFIG — EDIT THESE
       ========================= */
    const BRAND = {
      name: "TrailTrack Rentals",
      logoUrl: "assets/logo.svg",
      EMAILJS_PUBLIC_KEY: "Hkx4h1F3mYXQSZLnn",
      EMAILJS_SERVICE_ID: "service_jt9vrzm",
      EMAILJS_TEMPLATE_ID: "template_tqq8a0u"   // <— antes era template_xzn9ydm
    };

    // Apply logo and title from config
    document.title = BRAND.name + " — SUV Only";
    const logoImg = document.querySelector('img.logo');
    if (logoImg && BRAND.logoUrl) logoImg.src = BRAND.logoUrl;

    // --- Fleet (real SUV photos via Unsplash CDN links; replace with your photos anytime) ---
    const FLEET = [
      { id: 'suv-1', name: 'Ford Explorer XLT', img: 'https://images.unsplash.com/photo-1619767886558-efdc259cde1b?q=80&w=1200&auto=format&fit=crop', seats: 7, bags: 4, drivetrain: 'AWD', mpg: 24, daily: 45, features: ['Apple CarPlay','Android Auto','ADAS'] },
      { id: 'suv-2', name: 'Toyota Highlander LE', img: 'https://images.unsplash.com/photo-1583121274602-3e2820c69888?q=80&w=1200&auto=format&fit=crop', seats: 7, bags: 4, drivetrain: 'AWD', mpg: 26, daily: 35, features: ['Blind-spot','Lane Keep','Adaptive Cruise'] },
      { id: 'suv-3', name: 'Chevrolet Tahoe', img: 'https://images.unsplash.com/photo-1603384635076-0d67a6d5fca8?q=80&w=1200&auto=format&fit=crop', seats: 8, bags: 5, drivetrain: 'RWD', mpg: 20, daily: 25, features: ['V8','Towing Pkg','Tri-zone Climate'] },
    ];

    // --- Utilities ---
    function toCurrency(n){ return `$${n.toFixed(2)}` }
    function haversineDistanceKm([lat1, lon1], [lat2, lon2]){
      const toRad = d => (d * Math.PI) / 180; const R = 6371; const dLat = toRad(lat2 - lat1); const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(a));
    }
    function daysBetween(start, end){ const s=new Date(start), e=new Date(end); const ms=e - s; return Math.max(1, Math.ceil(ms / 86400000)); }

    // === Local date helpers ===
    function ymdLocal(d=new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function today(){ return ymdLocal(new Date()); }
    function tomorrow(){ const d = new Date(); d.setDate(d.getDate() + 1); return ymdLocal(d); }

    // === Soft persistence in localStorage ===
    const LS_KEY = 'trailtrack_state_v1';
    function saveState(){
      try {
        const state = {
          vehicleId: selected?.id,
          start: startEl.value,
          end: endEl.value,
          age: parseInt(ageEl.value,10),
          // pickup is static; store dropoff only
          dropoff
        };
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      } catch {}
    }
    function loadState(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if (s.start) startEl.value = s.start;
        if (s.end)   endEl.value   = s.end;
        if (s.age)   { ageEl.value = s.age; ageLabel.textContent = s.age + ' years'; }
        if (s.vehicleId) {
          const found = FLEET.find(v=>v.id===s.vehicleId);
          if (found) { selected = found; vehicleSel.value = found.id; }
        }
        if (Array.isArray(s.dropoff) && s.dropoff.length===2){ dropoff = s.dropoff; }
      } catch {}
    }

    // --- State ---
    let selected = FLEET[0];

    // STATIC PICKUP: set your fixed coordinates here (example: downtown Nashville)
   // STATIC PICKUP: set your fixed coordinates here (example: downtown Nashville)
const STATIC_PICKUP = [13.99058, -89.54759];


let pickup = STATIC_PICKUP.slice(); // fixed
let dropoff = STATIC_PICKUP.slice(); // fixed (same as pick-up)

    // Availability/UI state
    let availState = { status: 'unknown', available: false };

    function toggleCTAs(canBook){
      document.querySelectorAll('.est .btn').forEach(b => { b.disabled = !canBook; });
    }

    // --- DOM refs ---
    const fleetEl = document.getElementById('fleet');
    const vehicleSel = document.getElementById('vehicle');
    const startEl = document.getElementById('start');
    const endEl = document.getElementById('end');
    const ageEl = document.getElementById('age');
    const ageLabel = document.getElementById('ageLabel');
    const pickupField = document.getElementById('pickupField');
    const dropoffField = document.getElementById('dropoffField');

    const daysEl = document.getElementById('days');
    const baseLabel = document.getElementById('baseLabel');
    const baseEl = document.getElementById('base');
    const oneTimeEl = document.getElementById('oneTime');
    const under25Row = document.getElementById('under25Row');
    const under25El = document.getElementById('under25');
    const deliveryRow = document.getElementById('deliveryRow');
    const deliveryLabel = document.getElementById('deliveryLabel');
    const deliveryEl = document.getElementById('delivery');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total');

    // --- Map ---
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    });

    const map = L.map('map').setView(pickup, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const pickupMarker = L.marker(STATIC_PICKUP).addTo(map).bindPopup('Pick-up (fixed)');
    const dropoffMarker = L.marker(dropoff).addTo(map).bindPopup('Return');

    // Clicking map only updates dropoff (return)
    map.on('click', (e)=>{
      const p = [e.latlng.lat, e.latlng.lng];
      dropoff = p; dropoffMarker.setLatLng(p); setLocFields();
      updateEstimate();
      saveState();
    });

    function geo(which){
      if (which !== 'dropoff') return; // pickup is fixed
      if(!navigator.geolocation){ alert('Geolocation not supported'); return }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const p=[pos.coords.latitude, pos.coords.longitude];
        dropoff=p; dropoffMarker.setLatLng(p);
        map.setView(p, 13);
        setLocFields();
        updateEstimate();
        saveState();
      }, (err)=> alert(err.message), { enableHighAccuracy:true });
    }
    window.geo = geo;

    function setLocFields(){
      pickupField.value = STATIC_PICKUP.map(n=>n.toFixed(5)).join(', ');
      dropoffField.value = dropoff.map(n=>n.toFixed(5)).join(', ');
    }

    // --- UI build ---
    function buildFleet(){
      vehicleSel.innerHTML = FLEET.map(v=>`<option value="${v.id}">${v.name}</option>`).join('');
      fleetEl.innerHTML = FLEET.map((v,i)=>`
        <div class="vehicle ${i===0?'active':''}" data-id="${v.id}">
          <img src="${v.img}" alt="${v.name}">
          <div class="pad">
            <div class="row"><strong>${v.name}</strong><strong>$${v.daily}/day</strong></div>
            <div class="muted">Seats ${v.seats} • ${v.bags} bags • ${v.drivetrain} • ${v.mpg} mpg</div>
            <div class="chips">${v.features.map(f=>`<span class="chip">${f}</span>`).join('')}</div>
          </div>
        </div>`).join('');

      document.querySelectorAll('.vehicle').forEach(card=>{
        card.addEventListener('click', ()=>{
          document.querySelectorAll('.vehicle').forEach(c=>c.classList.remove('active'));
          card.classList.add('active');
          const id = card.getAttribute('data-id');
          selected = FLEET.find(v=>v.id===id);
          vehicleSel.value = selected.id;
          updateEstimate();
          saveState();
        });
      });

      vehicleSel.addEventListener('change', ()=>{
        const id = vehicleSel.value; selected = FLEET.find(v=>v.id===id);
        document.querySelectorAll('.vehicle').forEach(c=>c.classList.toggle('active', c.getAttribute('data-id')===id));
        updateEstimate();
        saveState();
      });
    }

    function initForm(){
      if (!startEl.value) startEl.value = today();
      if (!endEl.value)   endEl.value   = tomorrow();

      endEl.min = startEl.value;
      startEl.addEventListener('change', ()=>{
        endEl.min = startEl.value;
        if(endEl.value < startEl.value){ endEl.value = startEl.value }
        updateEstimate(); saveState();
      });
      endEl.addEventListener('change', ()=>{ updateEstimate(); saveState(); });
      ageEl.addEventListener('input', ()=>{ ageLabel.textContent = ageEl.value + ' years'; updateEstimate(); saveState(); });

      setLocFields();
    }

    function updateEstimate(){
      const days = daysBetween(startEl.value, endEl.value);
      const base = selected.daily * days;
      const oneTime = 4.99;
      const km = haversineDistanceKm(pickup, dropoff);
      const delivery = Math.max(0, Math.round(km * 3));
      const under25 = (parseInt(ageEl.value,10) < 25) ? 25 * days : 0;
      const tax = 0.04 * (base + oneTime + delivery + under25);
      const total = Math.round((base + oneTime + delivery + under25 + tax) * 100)/100;

      daysEl.textContent = days;
      baseLabel.textContent = `Base ($${selected.daily}/day)`;
      baseEl.textContent = toCurrency(base);
      oneTimeEl.textContent = toCurrency(oneTime);
      under25Row.style.display = under25 > 0 ? '' : 'none';
      under25El.textContent = toCurrency(under25);
      deliveryRow.style.display = delivery > 0 ? '' : 'none';
      deliveryLabel.textContent = `Different return (${km.toFixed(1)} km)`;
      deliveryEl.textContent = toCurrency(delivery);
      taxEl.textContent = toCurrency(tax);
      totalEl.textContent = toCurrency(total);

      // Check availability each time relevant values change
      checkAvailability().catch(()=>{});
    }

    // ======= Worker base (normalized, no trailing slash) =======
    const CHECKOUT_API = "https://trailtrack-checkout.youngdesert01.workers.dev".replace(/\/+$/,'');
    const WORKER_BASE  = CHECKOUT_API;

    // ======= Availability helper (UI message) =======
    async function checkAvailability(){
      const msg = document.getElementById('availMsg');
      availState.status = 'loading';
      toggleCTAs(false);
      msg.textContent = 'Checking availability…';
      msg.style.color = '';

      try{
        const res = await fetch(WORKER_BASE + "/availability", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ vehicleId: selected.id, startDate: startEl.value, endDate: endEl.value })
        });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        availState.status = 'ok';
        availState.available = !!data.available;

        if (data.available) {
          msg.style.color = '#15803d'; // green
          msg.textContent = 'Disponible para esas fechas ✔';
          toggleCTAs(true);
        } else {
          msg.style.color = '#9f1239'; // red
          msg.textContent = 'No disponible para esas fechas';
          toggleCTAs(false);
        }
      } catch(e){
        availState.status = 'error';
        availState.available = false;
        msg.style.color = '#b45309'; // amber
        msg.textContent = 'No se pudo verificar disponibilidad';
        toggleCTAs(false);
        console.error('availability error:', e);
      }
    }

    // ===== Toast =====
    function showToast(message, type="info"){ // type: info | success | error
      let el = document.getElementById('tt_toast');
      if (!el){
        el = document.createElement('div');
        el.id = 'tt_toast';
        el.style.position='fixed';
        el.style.right='16px'; el.style.bottom='16px';
        el.style.maxWidth='360px';
        el.style.padding='12px 14px';
        el.style.borderRadius='12px';
        el.style.boxShadow='0 8px 28px rgba(2,6,23,.15)';
        el.style.zIndex=9999;
        el.style.font='14px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif';
        el.style.whiteSpace='pre-line';
        document.body.appendChild(el);
      }
      const colors = {
        info:   ['#0ea5e9', '#e0f2fe', '#075985'],
        success:['#16a34a', '#dcfce7', '#065f46'],
        error:  ['#dc2626', '#fee2e2', '#7f1d1d']
      }[type] || ['#334155','#f1f5f9','#0f172a'];
      el.style.border = `1px solid ${colors[0]}`;
      el.style.background = colors[1];
      el.style.color = colors[2];
      el.textContent = message;
      el.style.display='block';
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display='none'; }, 6000);
    }

    async function reserve(){
      if (availState.status === 'ok' && !availState.available) {
        alert("Ese vehículo no está disponible para esas fechas.");
        return;
      }

      const emailInput = document.getElementById('email');
      const customerEmail = (emailInput?.value || "").trim();

      if (!customerEmail) { alert("Por favor escribe tu correo para enviarte la confirmación."); emailInput?.focus(); return; }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(customerEmail)) { alert("Por favor ingresa un correo válido."); emailInput?.focus(); return; }

      const [reserveBtn] = document.querySelectorAll('.est .btn');
      setButtonLoading(reserveBtn, true, "Sending…");
      try {
        const availRes = await fetch(WORKER_BASE + "/availability", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ vehicleId: selected.id, startDate: startEl.value, endDate: endEl.value })
        });
        const avail = await availRes.json();
        if (!avail.available) { showToast("Fechas no disponibles. Intenta otras fechas/vehículo.", "error"); return; }

        const payload = {
          vehicleId: selected.id,
          startDate: startEl.value,
          endDate: endEl.value,
          pickup, dropoff,
          driverAge: parseInt(ageEl.value,10),
          estimate: {
            base: baseEl.textContent,
            oneTime: oneTimeEl.textContent,
            under25: under25El.textContent,
            delivery: deliveryEl.textContent,
            tax: taxEl.textContent,
            total: totalEl.textContent,
          },
          customerEmail
        };

        const r = await fetch(WORKER_BASE + "/reserve-email", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (!r.ok) { const t = await r.text(); showToast("No se pudo enviar la reserva:\n" + t, "error"); return; }

        const data = await r.json();
        const holdTxt = data?.hold_expires_at ? `Tu hold expira: ${new Date(data.hold_expires_at).toLocaleString()}` : "";
        showToast(`¡Reserva enviada!\nTe escribiremos al correo indicado.\n${holdTxt}`, "success");
      } catch (e) {
        console.error("reserve error:", e);
        showToast("Error inesperado al enviar la reserva.", "error");
      } finally {
        setButtonLoading(reserveBtn, false);
      }
    }
    window.reserve = reserve;

    // Stripe Payment Link redirect
    async function payNow(){
      if (availState.status === 'ok' && !availState.available) { alert("Ese vehículo no está disponible para esas fechas."); return; }
      const [, payBtn] = document.querySelectorAll('.est .btn');
      setButtonLoading(payBtn, true, 'Redirecting…');
      try {
        const payload = {
          vehicleId: selected.id,
          startDate: startEl.value,
          endDate: endEl.value,
          pickup,
          dropoff,
          driverAge: parseInt(ageEl.value,10)
        };

        const res = await fetch(CHECKOUT_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if(!res.ok){ const t = await res.text(); showToast("Checkout error:\n" + t, "error"); return; }
        const { url } = await res.json();
        window.location.href = url; // Stripe Checkout
      } catch (e) {
        console.error("payNow error:", e);
        showToast("No se pudo iniciar el pago.\n" + (e?.message || e), "error");
      } finally {
        setButtonLoading(payBtn, false);
      }
    }
    window.payNow = payNow;

    // EmailJS contact form
    function isBot(){ return false; }
    function sendContact(e){
      e.preventDefault();
      const ok = BRAND.EMAILJS_PUBLIC_KEY && BRAND.EMAILJS_SERVICE_ID && BRAND.EMAILJS_TEMPLATE_ID;
      const success = document.getElementById('contactSuccess');
      const error = document.getElementById('contactError');
      success.style.display = 'none'; error.style.display = 'none';
      success.setAttribute('aria-live','polite'); error.setAttribute('aria-live','assertive');

      if(!ok){ error.textContent = "EmailJS keys not set. Edit the CONFIG at the bottom of index.html."; error.style.display = 'block'; return; }
      if (isBot()){ return; }

      const name = document.getElementById('cname').value.trim();
      const email = document.getElementById('cemail').value.trim();
      const message = document.getElementById('cmsg').value.trim();

      emailjs.init({ publicKey: BRAND.EMAILJS_PUBLIC_KEY });
      emailjs.send(BRAND.EMAILJS_SERVICE_ID, BRAND.EMAILJS_TEMPLATE_ID, { from_name: name, reply_to: email, message })
      .then(() => { success.textContent = "Thanks! Your message was sent."; success.style.display = 'block'; (document.getElementById('contactForm')).reset(); })
      .catch(() => { error.textContent = "Sorry, something went wrong sending your message."; error.style.display = 'block'; });
    }
    window.sendContact = sendContact;

    // Post-Stripe confirmation (?status=success/cancel)
    (function showStripeStatus(){
      const q = new URLSearchParams(location.search);
      const status = q.get('status');
      if (status === 'success') {
        showToast("✅ Pago completado. Te enviaremos un correo con los detalles.", "success");
      } else if (status === 'cancel') {
        showToast("Pago cancelado. Tu carrito sigue listo si quieres intentarlo de nuevo.", "info");
      }
    })();

    // Button loading helper
    function setButtonLoading(btn, loading, loadingText="Working…"){
      if (!btn) return;
      if (loading){ btn.dataset._label = btn.textContent; btn.textContent = loadingText; btn.disabled = true; }
      else { if (btn.dataset._label) btn.textContent = btn.dataset._label; btn.disabled = false; }
    }

    // Init
    buildFleet();
    loadState();
    initForm();
    updateEstimate();
    // initial availability check
    checkAvailability().catch(()=>{});
  </script>
</body>
</html>
